name: Node.js CI Checks

permissions:
  contents: read
  pull-requests: write
  issues: write   

on:
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ job.status }}
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
        working-directory: ./frontend
      - run: npm run build
        working-directory: ./frontend

  lint:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ job.status }}
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
        working-directory: ./frontend
      - run: npm run lint
        working-directory: ./frontend

  generate-comment:
    name: Generate PR Comment
    runs-on: ubuntu-latest
    needs: [build, lint]
    if: always()
    permissions:
      pull-requests: write
      issues: write   

    steps:
      - name: Generate comment content
        id: generate-content
        env:
          CI_STATUS: ${{ needs.build.outputs.status }}
          LINT_STATUS: ${{ needs.lint.outputs.status }}
        run: |
          COMMENT_FILE=$(mktemp)
          if [ "$CI_STATUS" == "success" ] && [ "$LINT_STATUS" == "success" ]; then
            echo "## âœ… All Checks Passed!" >> $COMMENT_FILE
            echo "" >> $COMMENT_FILE
            echo "**.Status:** âœ… Ready to merge" >> $COMMENT_FILE
          else
            echo "## âŒ Checks Failed" >> $COMMENT_FILE
            echo "**.Status:** ðŸ”´ Not ready to merge" >> $COMMENT_FILE
          fi
          echo "comment-body<<EOF" >> $GITHUB_OUTPUT
          cat $COMMENT_FILE >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post or Update PR Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.generate-content.outputs.comment-body }}
          edit-mode: replace
